version:                         2.1
orbs:
  aws-ecr:                       circleci/aws-ecr@6.11.0
  aws-ecs:                       circleci/aws-ecs@1.2.0

executors:
  docker_build:
    machine:
      docker_layer_caching:      true

jobs:
  build:
    machine:
      image:                     circleci/classic:edge
    steps:
      - checkout
      - run:
          name:                  docker-compose build
          command:               docker-compose build

  test:
    machine:
      image:                     circleci/classic:edge
    steps:
      - checkout
      - run:
          name:                  docker-compose up -d
          command:               docker-compose up -d
      - run:                     sleep 30
      - run:
          name:                  docker-compose run back rails db:create RAILS_ENV=test
          command:               docker-compose run back rails db:create RAILS_ENV=test
      - run:
          name:                  docker-compose run back rails db:migrate RAILS_ENV=test
          command:               docker-compose run back rails db:migrate RAILS_ENV=test
      - run:
          name:                  docker-compose run back bundle exec rspec spec
          command:               docker-compose run back bundle exec rspec spec
      - run:
          name:                  docker-compose down
          command:               docker-compose down

  aws-ecr/build_and_push_image:
    executor:                    dockcer_build
    name:                        'build-prod'
    account-url:                 AWS_ECR_ACCOUNT_URL
    region:                      AWS_REGION
    repo:                        AWS_ECR_REPO_BACK
    tag:                         "${CIRCLE_SHA1}"
    path:                        ./back
    dockerfile:                  Dockerfile.pro


workflows:
    version:                     2
    build_and_test:
      jobs:
      - build
      - test:
          requires:
            - build
      - aws-ecr/build_and_push_image:
      #     requires:
      #       - build

# orbs:
#   aws-ecr:                     circleci/aws-ecr@6.0.0
#   aws-ecs:                     circleci/aws-ecs@1.2.0
#
# workflows:
#   build-and-deploy::
#     jobs:
#       - aws-ecr/build-and-push-image:
#           region:              AWS_REGION
#           account-url:         AWS_ECR_ACCOUNT_URL
#           repo:                '${MY_APP_PREFIX}-sample'
#           path:                '/back'
#           tag:                 "${CIRCLE_SHA1}"
#
#       - aws-ecr/build-and-push-image:
#           account-url:         AWS_ECR_ACCOUNT_URL
#           aws-access-key-id:   AWS_ACCESS_KEY_ID
#           aws-secret-access-key: AWS_SECRET_ACCESS_KEY
#           create-repo:         true
#           dockerfile:          Dockerfile
#           path:                .
#           region:              AWS_REGION
#           repo:                circleci-ecr-orb-demo
#           tag:                 "$CIRCLE_SHA1"
#
#       - aws-ecs/deploy-service-update:
#           requires:
#             - aws-ecr/build-and-push-image
#           family:              '${MY_APP_PREFIX}-task'
#           cluster-name:        '${MY_APP_PREFIX}-cluster'
#           service-name:        '${MY_APP_PREFIX}-service'
#           container-image-name-updates: 'container=${MY_APP_PREFIX}-container,tag=${CIRCLE_SHA1}'
