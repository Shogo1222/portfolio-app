version:                                  2.1
orbs:
  aws-ecr:                                circleci/aws-ecr@1.0.0
  aws-ecs:                                circleci/aws-ecs@1.2.0

jobs:
  build:
    machine:
      image:                              circleci/classic:edge
    steps:
      - checkout
      - run:
          name:                           docker-compose build
          command:                        docker-compose build

  test:
    machine:
      image:                              circleci/classic:edge
    steps:
      - checkout
      - run:
          name:                           docker-compose up -d
          command:                        docker-compose up -d
      - run:                              sleep 30
      - run:
          name:                           docker-compose run back rails db:create RAILS_ENV=test
          command:                        docker-compose run back rails db:create RAILS_ENV=test
      - run:
          name:                           docker-compose run back rails db:migrate RAILS_ENV=test
          command:                        docker-compose run back rails db:migrate RAILS_ENV=test
      - run:
          name:                           docker-compose run back bundle exec rspec spec
          command:                        docker-compose run back bundle exec rspec spec
      - run:
          name:                           docker-compose down
          command:                        docker-compose down

workflows:
    build_and_test_and_deploy:
      jobs:
      - build
      - test:
          requires:
            - build
      - aws-ecr/build_and_push_image:
            name:                         'build-and-push-back'
            account-url:                  AWS_ECR_ACCOUNT_URL
            region:                       AWS_REGION
            repo:                         back
            tag:                          "${CIRCLE_SHA1}"
            path:                         './back'
            dockerfile:                   back/Dockerfile.pro
            requires:
              - test
          filters:
            branches:
              only:
                - master
      - aws-ecr/build_and_push_image:
            name:                         'build-and-push-front'
            account-url:                  AWS_ECR_ACCOUNT_URL
            region:                       AWS_REGION
            repo:                         front
            tag:                          "${CIRCLE_SHA1}"
            path:                         './front'
            dockerfile:                   front/Dockerfile.pro
            requires:
              - test
          filters:
            branches:
              only:
                - master
      - aws-ecs/deploy-service-update:
            family:                       'back'
            service-name:                 'back'
            cluster-name:                 ${CLUSTER_NAME}
            container-image-name-updates: 'container=back,image-and-tag=${AWS_ECR_ACCOUNT_URL}/back:${CIRCLE_SHA1}'
            requires:
              - build-and-push-back
          filters:
            branches:
              only:
                - master
      - aws-ecs/deploy-service-update:
            family:                       'front'
            service-name:                 'front'
            cluster-name:                 ${CLUSTER_NAME}
            container-image-name-updates: 'container=front,image-and-tag=${AWS_ECR_ACCOUNT_URL}/front:${CIRCLE_SHA1}'
            requires:
              - build-and-push-front
          filters:
            branches:
              only:
                - master
